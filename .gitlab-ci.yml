stages:          # List of stages for jobs, and their order of execution
  - test
  - build
  - staging
  - production

test: # temp job
  stage: test
  script:
    - echo 'testing'

# Client
build 1/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/client"  
      --dockerfile "${CI_PROJECT_DIR}/services/client/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/client:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/client/*
        - k8s/client.yaml

# API Gateway
build 2/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/api-gateway"  
      --dockerfile "${CI_PROJECT_DIR}/services/api-gateway/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/api-gateway:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/api-gateway/*
        - k8s/api-gateway.yaml

# Auth
build 3/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/auth"  
      --dockerfile "${CI_PROJECT_DIR}/services/auth/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/auth:${CI_COMMIT_TAG:-latest}"
  when: manual

# Profile    
build 4/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/profile"  
      --dockerfile "${CI_PROJECT_DIR}/services/profile/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/profile:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/profile/*
        - k8s/profile.yaml

# Feed
build 5/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/feed"  
      --dockerfile "${CI_PROJECT_DIR}/services/feed/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/feed:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/feed/*
        - k8s/feed.yaml

# Lit Write
build 6/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/lit-write"  
      --dockerfile "${CI_PROJECT_DIR}/services/lit-write/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/lit-write:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/lit-write/*
        - k8s/lit-write.yaml

# Lit Read
build 7/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/lit-read"  
      --dockerfile "${CI_PROJECT_DIR}/services/lit-read/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/lit-read:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/lit-read/*
        - k8s/lit-read.yaml

# User Write
build 8/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/user-write"  
      --dockerfile "${CI_PROJECT_DIR}/services/user-write/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/user-write:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/user-write/*
        - k8s/user-write.yaml

# User Read
build 9/9:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug 
    entrypoint: [""]
  script:  # See https://docs.gitlab.com/ee/ci/docker/using_kaniko.html
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/services/user-read"  
      --dockerfile "${CI_PROJECT_DIR}/services/user-read/Dockerfile.production"
      --destination "${CI_REGISTRY_IMAGE}/user-read:${CI_COMMIT_TAG:-latest}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:  # Include the job and set to when:manual if any of the follow paths match a modified file.
        - services/user-read/*
        - k8s/user-read.yaml
